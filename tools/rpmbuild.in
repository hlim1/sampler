#!/usr/bin/perl -w
# -*- cperl -*-

use strict;
use FindBin;


########################################################################


my $scheme = shift
    or die "Usage: $0 <scheme> <rpmbuild flags> ...\n";

@find_driver_fragment@
$ENV{CC} = "$driver $scheme";

$scheme =~ s/ --threads( |$)//;


########################################################################


my %macros = (
	      sampler_scheme => $scheme,

	      'sampler_tags(s:)' => <<'EOF',
Requires: sampler-gnome
BuildRequires: sampler-devel
%global _sampler_source %{-s*}%{!-s:1}
Source%{_sampler_source}: %{name}-sampler.tar.gz
EOF

	      sampler_description => 'This package has been built with sampled %{sampler_scheme} instrumentation.',

	      sampler_package => <<'EOF',
%package samplerinfo
Summary: Sampler information for package %{name}
Group: Development/Debug
AutoReqProv: 0
%description samplerinfo
This package provides sampler information for package %{name}, built
using the "%{sampler_scheme}" instrumentation scheme.  You do not need
this to use %{name}.  Most users have no need to install this package.
%files samplerinfo
%defattr(-,root,root)
%{_libdir}/sampler/sites/*
EOF

	      sampler_prep => <<'EOF',
mkdir sampler
tar xzf %{S:%{_sampler_source}} -C sampler
EOF

	      sampler_build => <<'EOF',
sed -e 's/@name@/%{name}/g' -e 's/@version@/%{version}/g' -e 's/@release@/%{release}/g' -e 's/@scheme@/%{sampler_scheme}/g' <sampler/config.in >sampler/config
sed -e 's!@_launcherdir@!%{_datadir}/sampler/launcher!g' <sampler/wrapper.in >sampler/wrapper
EOF

	      'sampler_install(x:)' => <<'EOF',
install -d %{buildroot}%{_libdir}/sampler/applications/%{name}
for file in config %{name}-sampler.schemas interface.glade wrapper; do
  install sampler/$file %{buildroot}%{_libdir}/sampler/applications/%{name}
done
mv %{buildroot}%{-x*}%{!-x:%{_bindir}/%{name}} %{buildroot}%{_libdir}/sampler/applications/%{name}/executable
ln -s %{_libdir}/sampler/applications/%{name}/wrapper %{buildroot}%{-x:-x*}%{!-x:%{_bindir}/%{name}}
install -d %{buildroot}%{_sysconfdir}/gconf/schemas
install sampler/%{name}-sampler.schemas %{buildroot}%{_sysconfdir}/gconf/schemas
%{_libdir}/sampler/tools/find-sampler-info $RPM_BUILD_ROOT
EOF

	      sampler_files => <<'EOF',
%attr(-, root, root) %{_libdir}/sampler/applications/%{name}
%attr(-, root, root) %{_sysconfdir}/gconf/schemas/%{name}-sampler.schemas
EOF

	      sampler_post => 'env GCONF_CONFIG_SOURCE=`gconftool-2 --get-default-source` gconftool-2 --makefile-install-rule %{_sysconfdir}/gconf/schemas/%{name}-sampler.schemas >/dev/null'
);


########################################################################


while (my ($name, $value) = each %macros) {
    $value =~ s/\n(?=.)/\\\n/g;
    unshift @ARGV, '--define', "$name $value";
}

exec 'rpmbuild', @ARGV;
die "cannot exec rpmbuild: $!\n";
