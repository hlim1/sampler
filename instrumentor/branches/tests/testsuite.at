AT_INIT(branches)

AT_SETUP(simple)
AT_CHECK(
set -e
cp $abs_srcdir/simple.c .
cp $abs_srcdir/simple.expected expout
$abs_top_builddir/instrumentor/driver/main branches -o simple simple.c
SAMPLER_FILE=trace SAMPLER_SPARSITY=1 ./simple
$abs_top_srcdir/resolver/resolve-samples simple <trace
, 0, expout)
AT_CLEANUP

AT_SETUP(modular)
AT_CHECK(
set -e
cp $abs_srcdir/modular-*.c .
cp $abs_srcdir/modular.expected expout
$abs_top_builddir/instrumentor/driver/main branches -o modular *.c
SAMPLER_FILE=trace SAMPLER_SPARSITY=1 ./modular
$abs_top_srcdir/resolver/resolve-samples modular <trace
, 0, expout)
AT_CLEANUP

AT_SETUP(sharing)
AT_CHECK([
set -e
cp $abs_srcdir/plugin.c .
cp $abs_srcdir/library.c .
cp $abs_srcdir/library.h .
cp $abs_srcdir/sharing.c .
cp $abs_srcdir/sharing.expected expout
cc="$abs_top_builddir/instrumentor/driver/main branches -save-temps"
$cc -shared -o plugin.so plugin.c
$cc -shared -o library.so library.c
$cc -c sharing.c
$cc -Wl,-rpath,. -o sharing sharing.o library.so -ldl
SAMPLER_FILE=trace SAMPLER_SPARSITY=1 ./sharing
$abs_top_srcdir/resolver/resolve-samples sharing library.so plugin.so <trace
], 0, expout)
AT_CLEANUP

AT_SETUP(threads)
AT_CHECK(
set -e
cp $abs_srcdir/threads.c .
cp $abs_srcdir/threads.expected expout
$abs_top_builddir/instrumentor/driver/main branches -pthread -o threads threads.c
SAMPLER_FILE=trace SAMPLER_SPARSITY=1 ./threads >/dev/null
$abs_top_srcdir/resolver/resolve-samples threads <trace
, 0, expout)
AT_CLEANUP
