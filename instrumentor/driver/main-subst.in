#!/usr/bin/perl -w

use strict;
use FindBin;
use lib "$FindBin::Bin";
use lib "$FindBin::Bin/../cil/lib";

my $schemeName = shift or die "Usage: $0 <scheme> [<compiler arguments> ...]\n";

our $have_thread_storage = '@HAVE_THREAD_STORAGE@';
our $cc = '@CC@';
our $libm = '@LIBM@';
our $root = "$FindBin::Bin/@top_srcdir@";
our $scheme = "$FindBin::Bin/../$schemeName";

# sanity checks
die "internal error: $root is not sampler's root directory\n" unless -f "$root/lib/countdown.h";
die "no such instrumentation scheme: $schemeName ($scheme/main is not executable)\n" unless -x "$scheme/main";

my $module = "$::scheme/Driver.pm";
unless (my $return = do $module) {
    warn "cannot parse instrumentation module $module: $!\n" if $@;
    warn "cannot read instrumentation module $module: $!\n" unless defined $return;
    warn "cannot run instrumentation module $module\n" unless $return;
    die;
}

Driver->new(@ARGV)->doit();
